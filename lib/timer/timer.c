/********************************Copyright (c)**********************************\
**
**                   (c) Copyright 2019, Main, China, QD.
**                           All Rights Reserved
**
**                                 By(wo4fisher)
**                           http://www.wo4fisher.com
**
**----------------------------------文件信息------------------------------------
** 文件名称: timer.c
** 创建人员: wht
** 创建日期: 2019-02-17
** 文档描述:
**
**----------------------------------版本信息------------------------------------
** 版本代号: V0.1
** 版本说明: 初始版本
**
**------------------------------------------------------------------------------
\********************************End of Head************************************/
#include "timer.h"

/*System ticks*/
static volatile unsigned long idata g_sys_ticks;

/*******************************************************************************
** 函数名称: Timer4Init
** 功能描述: Timer 4 as system tick timer. 1KHZ
** 参数说明: None
** 返回说明: None
** 创建人员: wht
** 创建日期: 2019-02-18
**------------------------------------------------------------------------------
** 修改人员:wht
** 修改日期:
** 修改描述:
**------------------------------------------------------------------------------
********************************************************************************/
void Timer4Init(void)       //1毫秒@11.0592MHz
{
    T4T3M |= 0x20;      //定时器时钟1T模式
    T4L = 0xCD;     //设置定时初值
    T4H = 0xD4;     //设置定时初值
    T4T3M |= 0x80;      //定时器4开始计时
    IE2 |= 0x40;      //开定时器4中断

}

/*******************************************************************************
** 函数名称: time_GetTicks
** 功能描述: 获取系统滴答计数值
** 参数说明: None
** 返回说明: None
** 创建人员: wht
** 创建日期: 2019-02-18
**------------------------------------------------------------------------------
** 修改人员:wht
** 修改日期:
** 修改描述:
**------------------------------------------------------------------------------
********************************************************************************/
unsigned long time_GetTicks(void)
{
    unsigned long ticks;
    EA = 0;
    ticks = g_sys_ticks;
    EA = 1;
    return ticks;
}

/*******************************************************************************
** 函数名称: timer4_ISR
** 功能描述: 系统滴答定时器中断服务函数
** 参数说明: None
** 返回说明: None
** 创建人员: wht
** 创建日期: 2019-02-18
**------------------------------------------------------------------------------
** 修改人员:wht
** 修改日期:
** 修改描述:
**------------------------------------------------------------------------------
********************************************************************************/
void timer4_ISR(void) interrupt 20
{
    g_sys_ticks ++;
    //  IE2 &= ~0x40;                   //若需要手动清除中断标志,可先关闭中断,此时系统会自动清除内部的中断标志
    //  IE2 |= 0x40;                    //然后再开中断即可
}
/*******************************************************************************
** 函数名称: Timer3Init
** 功能描述: Timer 3 music interrupt
** 参数说明: None
** 返回说明: None
** 创建人员: wht
** 创建日期: 2019-06-07
**------------------------------------------------------------------------------
** 修改人员:wht
** 修改日期:
** 修改描述:
**------------------------------------------------------------------------------
********************************************************************************/
void Timer3Init(void)       //1毫秒@11.0592MHz
{
    T3H=0xd8;
    T3L=0xef;
	  T4T3M|=0X08;
	  IE2|=0x20;
}

/********************************End of File************************************/
